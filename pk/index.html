<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>サッカーPKゲーム (疑似3D・UIイメージ)</title>
  <style>
    body {
      margin: 0;
      background-color: #000;
      font-family: Arial, sans-serif;
      color: #fff;
      text-align: center;
    }
    #gameCanvas {
      display: block;
      margin: 0 auto;
      background: #333;
      border: 1px solid #999;
    }
    /* UI要素をキャンバス上に重ねるためのコンテナ */
    #gameContainer {
      position: relative;
      width: 800px;
      margin: 20px auto; /* 中央寄せ */
    }
    #gameCanvas {
      width: 800px;
      height: 600px;
      z-index: 1;
    }
    /* 画面中央のメッセージ */
    .center-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 32px;
      font-weight: bold;
      color: #fff;
      pointer-events: none; /* クリックなどを透過 */
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }
    /* スコアやカウントなどのUI */
    .score-ui {
      position: absolute;
      bottom: 20px;
      left: 20px;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
    }
    .count-ui {
      position: absolute;
      bottom: 20px;
      right: 20px;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
    }
    /* 右上のボタンアイコン */
    .top-buttons {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
    }
    .btn-icon {
      width: 40px;
      height: 40px;
      background-color: rgba(255,255,255,0.2);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
    }
    .btn-icon:hover {
      background-color: rgba(255,255,255,0.4);
    }
  </style>
</head>
<body>
  <h1>サッカーPKゲーム (疑似3Dイメージ)</h1>
  <div id="gameContainer">
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <!-- 中央メッセージ -->
    <div class="center-message" id="centerMessage">SWIPE TO KICK THE BALL</div>

    <!-- スコア表示 -->
    <div class="score-ui" id="scoreUI">SCORE 0</div>
    <!-- カウント表示 -->
    <div class="count-ui" id="countUI">0/15</div>

    <!-- 右上ボタン群 -->
    <div class="top-buttons">
      <div class="btn-icon" onclick="togglePause()">⏸</div>  <!-- 一時停止ボタン -->
      <div class="btn-icon" onclick="toggleSound()">🔊</div> <!-- 音量ボタン(仮) -->
    </div>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const centerMessage = document.getElementById('centerMessage');
    const scoreUI = document.getElementById('scoreUI');
    const countUI = document.getElementById('countUI');

    // ゲーム状態
    let paused = false;
    let score = 0;
    let shotCount = 0;
    const maxShots = 15;

    // 疑似3D用スケール計算
    const horizon = 50;          // ゴールライン（上側）に近い位置
    const minScale = 0.3;
    const maxScale = 1.2;

    function getScale(y) {
      // y: 0～600 (canvas.height)
      // horizon(50)～600 の間でスケール補間
      if (y < horizon) y = horizon;
      return minScale + (maxScale - minScale) * ((y - horizon) / (canvas.height - horizon));
    }

    // 背景・ゴールネット・フィールドの描画
    function drawBackground() {
      // 背景全体を塗りつぶし (スタジアム風にグラデーションをかけるなど)
      const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
      grad.addColorStop(0, '#89CFF0'); // 空色
      grad.addColorStop(0.3, '#AAD751'); // 観客席っぽい色(仮)
      grad.addColorStop(1, '#228B22'); // フィールドの緑
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // ゴールネット (奥の線) を簡易的に
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 2;
      // 横ライン
      for (let i = 0; i < 5; i++) {
        ctx.beginPath();
        ctx.moveTo(canvas.width * 0.3, horizon + i * 10);
        ctx.lineTo(canvas.width * 0.7, horizon + i * 10);
        ctx.stroke();
      }
      // 縦ライン
      for (let j = 0; j < 5; j++) {
        ctx.beginPath();
        ctx.moveTo(canvas.width * (0.3 + j * 0.1), horizon);
        ctx.lineTo(canvas.width * (0.3 + j * 0.1), horizon + 40);
        ctx.stroke();
      }
    }

    // ボール画像の読み込み
    const ballImage = new Image();
    ballImage.src = "ball.webp";

    // ボールオブジェクト
    const ball = {
      x: canvas.width / 2,
      y: 500,
      radius: 40,   // 大きめにして、手前感を演出
      vx: 0,
      vy: 0,
      isShooting: false
    };

    // ゴールキーパー
    const goalkeeper = {
      x: canvas.width / 2,
      y: 100,       // ゴールラインより少し手前
      width: 50,
      height: 50,
      vx: 2
    };

    // ボールを描画（画像使用）
    function drawBall() {
      const scale = getScale(ball.y);
      const r = ball.radius * scale;

      // 画像が読み込まれていれば画像で描画、未読み込みなら白い円を表示
      if (ballImage.complete && ballImage.naturalWidth !== 0) {
        // ボールの中心が (ball.x, ball.y) になるように描画
        ctx.drawImage(ballImage, ball.x - r, ball.y - r, r * 2, r * 2);
      } else {
        // 画像が未読込の場合のフォールバック（白い円）
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, r, 0, Math.PI * 2);
        ctx.fillStyle = '#ffffff';
        ctx.fill();
        ctx.strokeStyle = '#000000';
        ctx.stroke();
        ctx.closePath();
      }
    }

    // ゴールキーパーを描画 (ここでは四角形+頭部の円)
    function drawGoalkeeper() {
      const scale = getScale(goalkeeper.y);
      const w = goalkeeper.width * scale;
      const h = goalkeeper.height * scale;
      ctx.fillStyle = '#555';
      ctx.fillRect(goalkeeper.x - w/2, goalkeeper.y - h, w, h);
      // 頭部を円で描画
      ctx.beginPath();
      ctx.arc(goalkeeper.x, goalkeeper.y - h - (10*scale), 10*scale, 0, Math.PI*2);
      ctx.fillStyle = '#ccc';
      ctx.fill();
    }

    // ゴールキーパーの移動 (ゴール範囲内を左右に)
    function updateGoalkeeper() {
      goalkeeper.x += goalkeeper.vx;
      const leftLimit = canvas.width * 0.3;
      const rightLimit = canvas.width * 0.7;
      if (goalkeeper.x < leftLimit) {
        goalkeeper.x = leftLimit;
        goalkeeper.vx *= -1;
      }
      if (goalkeeper.x > rightLimit) {
        goalkeeper.x = rightLimit;
        goalkeeper.vx *= -1;
      }
    }

    // ボールの移動
    function updateBall() {
      if (!ball.isShooting) return;
      ball.x += ball.vx;
      ball.y += ball.vy;
      // 摩擦
      ball.vx *= 0.98;
      ball.vy *= 0.98;
    }

    // ゴール判定 (地平線より上に行ったらゴール判定)
    function checkGoal() {
      if (ball.y < horizon + 20) {
        // ボールがゴールライン付近を通過したのでゴール判定
        // キーパーの位置とボールの位置が重なってなければゴール
        const distGK = Math.hypot(ball.x - goalkeeper.x, ball.y - goalkeeper.y);
        const scaleGK = getScale(goalkeeper.y);
        const gkRadius = 25 * scaleGK; // ゴールキーパーの当たり判定(適当)
        const scaleBall = getScale(ball.y);
        const ballRadius = ball.radius * scaleBall;

        if (distGK > gkRadius + ballRadius) {
          // ゴール成功
          score++;
          alert("GOAL!!");
        } else {
          // セーブ
          alert("Saved by GK!");
        }
        resetBall();
      }
    }

    // ボールとキーパーの衝突判定 (正面で当たった場合の補助)
    function checkCollision() {
      if (!ball.isShooting) return;
      const dist = Math.hypot(ball.x - goalkeeper.x, ball.y - goalkeeper.y);
      const scaleGK = getScale(goalkeeper.y);
      const gkRadius = 25 * scaleGK;
      const scaleBall = getScale(ball.y);
      const ballRadius = ball.radius * scaleBall;

      if (dist < gkRadius + ballRadius) {
        // キーパーに当たった
        alert("Saved by GK!");
        resetBall();
      }
    }

    // ボールリセット
    function resetBall() {
      ball.x = canvas.width / 2;
      ball.y = 500;
      ball.vx = 0;
      ball.vy = 0;
      ball.isShooting = false;

      shotCount++;
      if (shotCount >= maxShots) {
        alert("ゲーム終了！ あなたのスコア: " + score);
        shotCount = 0;
        score = 0;
      }
      updateUI();
    }

    // UI更新
    function updateUI() {
      scoreUI.textContent = "SCORE " + score;
      countUI.textContent = shotCount + "/" + maxShots;
    }

    // マウス操作 (ドラッグでシュート方向とパワーを決定)
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };

    canvas.addEventListener('mousedown', (e) => {
      if (!ball.isShooting) {
        isDragging = true;
        dragStart.x = e.offsetX;
        dragStart.y = e.offsetY;
      }
    });
    canvas.addEventListener('mouseup', (e) => {
      if (isDragging) {
        isDragging = false;
        const dx = dragStart.x - e.offsetX;
        const dy = dragStart.y - e.offsetY;
        // シュートベクトル（上下左右を反転）
        ball.vx = -dx * 0.2;
        ball.vy = -dy * 0.2;
        ball.isShooting = true;
        centerMessage.style.display = "none";
      }
    });

    // メインループ
    function gameLoop() {
      if (paused) {
        requestAnimationFrame(gameLoop);
        return;
      }

      drawBackground();
      updateGoalkeeper();
      updateBall();

      drawGoalkeeper();
      drawBall();

      if (ball.isShooting) {
        checkCollision(); // キーパーとの衝突
        checkGoal();      // ゴール判定
      }

      requestAnimationFrame(gameLoop);
    }

    // ポーズボタン
    function togglePause() {
      paused = !paused;
      if (!paused) {
        gameLoop();
      }
    }
    // 音量ボタン（デモでは機能はダミー）
    function toggleSound() {
      alert("サウンドのオン/オフを切り替える想定です。");
    }

    // 初期化
    updateUI();
    gameLoop();
  </script>
</body>
</html>
